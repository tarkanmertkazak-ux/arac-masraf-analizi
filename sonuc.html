<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Araç Masraf Analizi</title>

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#eaf6fb,#f7fcfe);
  padding:20px;
  color:#1f2937;
}

.container{
  max-width:900px;
  margin:auto;
  background:#ffffff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 6px 30px rgba(32,33,36,0.08);
}

h1,h3{margin-top:20px;color:#0f172a}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
  margin:6px 6px 6px 0;
}

.primary{background:#3498db;color:#fff}
.success{background:#10b981;color:#fff}
.danger{background:#ef4444;color:#fff}
.gray{background:#64748b;color:#fff}

/* BAR */
.bar-container{
  width:100%;
  background:#eef2f6;
  border-radius:8px;
  margin-bottom:10px;
  overflow:hidden;
}
.bar{
  height:30px;
  line-height:30px;
  padding-left:12px;
  border-radius:6px;
  font-size:14px;
  color:#fff;
  font-weight:600;
  box-sizing:border-box;
}

/* color variants */
.low{background:linear-gradient(90deg,#10b981,#34d399)}
.mid{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.high{background:linear-gradient(90deg,#ef4444,#fb6b6b)}
.neutral{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.kmbar{background:linear-gradient(90deg,#0ea5a4,#5eead4)}
.satisbar{background:linear-gradient(90deg,#6366f1,#818cf8)}
.masrafbar{background:linear-gradient(90deg,#2563eb,#38bdf8)}

.kendi-box{
  background:#f8fafc;
  padding:12px;
  border-radius:8px;
}
.kendi-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.kendi-item button{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.kendi-item .danger{background:#ef4444;color:#fff}

/* small helper */
.info{margin:12px 0;color:#334155}
</style>
</head>

<body>

<div class="container">

  <h1 id="baslik">Araç Masraf Analizi</h1>

  <button class="danger" id="yasadimBtn">Bu aracı kullanırken masraf yaşadım</button>
  <button class="success" id="yasamadimBtn">Bu aracı kullanırken masraf yaşamadım</button>
  <button class="gray" onclick="location.href='arac-sec.html'">← Araç Seçimine Dön</button>

  <hr>

  <div id="istatistik" class="info"></div>

  <h3>Masraf Riski</h3>
  <div id="riskGrafik"></div>

  <h3>Masraf Türleri</h3>
  <div id="masrafGrafik"></div>

  <h3>Bin KM Aralıkları</h3>
  <div id="kmGrafik"></div>

  <h3>Satış Süresi</h3>
  <div id="satisGrafik"></div>

  <h3>Senin Bildirimin</h3>
  <div id="kendiBildirim" class="kendi-box"></div>

</div>

<script>
// GİRİŞ KONTROLÜ
if(!localStorage.getItem("userEmail")){
  location.href="index.html";
}

// USER ID
let userId = localStorage.getItem("userId");
if(!userId){
  userId = "u_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

// AKTİF ARAÇ
const arac = JSON.parse(localStorage.getItem("aktifArac"));
if(!arac) {
  location.href = "arac-sec.html";
}
const key = `${arac.marka}-${arac.model}-${arac.yil}-${arac.motor}`;
document.getElementById("baslik").innerText =
  `${arac.marka} ${arac.model} (${arac.yil}) - ${arac.motor}`;

// VERİLER (localStorage)
let masraflar = JSON.parse(localStorage.getItem(key + "_masraf")) || [];
let sorunsuz = JSON.parse(localStorage.getItem(key + "_sorunsuz")) || [];

/**
 * render()
 * - tüm grafik ve bölümleri günceller
 * - satış süresi hesaplaması: artık hem masraflar hem de sorunsuz kayıtlardaki 'satis' veya 'satisGun' alanlarını dikkate alır
 */
function render(){

  // geçerli sorunsuz kayıtlar (geçerli kabul edilenler)
  const gecerliSorunsuz = sorunsuz.filter(s => s.gecerli !== false); // sizin kodda gecerli: true/false olabilir

  // toplam kullanıcı (masraf veya geçerli sorunsuz olarak sayılacak)
  const toplamKullanici = new Set([
    ...masraflar.map(m => m.userId),
    ...gecerliSorunsuz.map(s => s.userId)
  ]).size;

  const masrafci = new Set(masraflar.map(m => m.userId)).size;
  const riskOran = toplamKullanici ? Math.round((masrafci / toplamKullanici) * 100) : 0;

  document.getElementById("istatistik").innerHTML =
    `<strong>${toplamKullanici} kullanıcıdan ${masrafci} kullanıcı masraf bildirdi</strong>`;

  // risk bar
  let riskClass = "low";
  if(riskOran > 60) riskClass = "high";
  else if(riskOran > 25) riskClass = "mid";
  document.getElementById("riskGrafik").innerHTML =
    `<div class="bar-container"><div class="bar ${riskClass}" style="width:${riskOran}%">Masraf Riski %${riskOran}</div></div>`;

  // --- MASRAF TÜRLERİ ---
  const turSayac = {};
  masraflar.forEach(m => {
    const t = m.tur || "Bilinmiyor";
    turSayac[t] = (turSayac[t] || 0) + 1;
  });

  document.getElementById("masrafGrafik").innerHTML =
    Object.keys(turSayac).length
      ? Object.keys(turSayac).map(t => {
          const denom = masraflar.length || 1;
          const y = Math.round((turSayac[t] / denom) * 100);
          return `<div class="bar-container"><div class="bar masrafbar" style="width:${y}%">${t} %${y}</div></div>`;
        }).join("")
      : "<em>Masraf verisi yok</em>";

  // --- KM ARALIKLARI ---
  const kmSayac = {};
  masraflar.forEach(m => {
    const k = m.km || "Bilinmiyor";
    kmSayac[k] = (kmSayac[k] || 0) + 1;
  });

  document.getElementById("kmGrafik").innerHTML =
    Object.keys(kmSayac).length
      ? Object.keys(kmSayac).map(k => {
          const denom = masraflar.length || 1;
          const y = Math.round((kmSayac[k] / denom) * 100);
          return `<div class="bar-container"><div class="bar kmbar" style="width:${y}%">${k} %${y}</div></div>`;
        }).join("")
      : "<em>KM verisi yok</em>";

  // --- SATIŞ SÜRESİ (DÜZELTİLDİ) ---
  // Not: bazı kayıtlarda alan adı 'satis', bazı yerlerde 'satisGun' olabilir.
  const satisSayac = {"0-15":0, "15-30":0, "30+":0};

  function extractSatisValue(obj){
    // öncelik: obj.satis, sonra obj.satisGun, sonra undefined
    return obj.satis || obj.satisGun || "";
  }

  masraflar.forEach(m => {
    const s = extractSatisValue(m);
    if(s && satisSayac.hasOwnProperty(s)) satisSayac[s]++;
  });
  gecerliSorunsuz.forEach(srec => {
    const s = extractSatisValue(srec);
    if(s && satisSayac.hasOwnProperty(s)) satisSayac[s]++;
  });

  const toplamSatis = Object.values(satisSayac).reduce((a,b) => a + b, 0);

  document.getElementById("satisGrafik").innerHTML =
    toplamSatis
      ? Object.keys(satisSayac).map(k => {
          const y = Math.round((satisSayac[k] / (toplamSatis || 1)) * 100);
          return `<div class="bar-container"><div class="bar satisbar" style="width:${y}%">${k} gün %${y}</div></div>`;
        }).join("")
      : "<em>Satış süresi verisi yok</em>";

  // --- KENDİ BİLDİRİM (SİL BUTONLU) ---
  const alan = document.getElementById("kendiBildirim");
  // map ile orijinal index i taşıyoruz, sonra filtreleyip gösteriyoruz
  const benim = masraflar.map((m,i) => ({...m, _i:i})).filter(m => m.userId === userId);

  if(benim.length){
    alan.innerHTML = benim.map(m =>
      `<div class="kendi-item">
         <div>${m.tur || "—"} <small>(${m.km||"—"})</small></div>
         <div><button class="danger" onclick="silMasraf(${m._i})">Sil</button></div>
       </div>`
    ).join("");
  } else {
    // kontrol: eğer kullanıcının "sorunsuz" (yani masraf yaşamadım) kaydı varsa göster
    const benimSorunsuz = sorunsuz.find(s => s.userId === userId);
    if(benimSorunsuz){
      alan.innerHTML = `Bu araçta masraf yaşamadığını bildirdin. (KM: ${benimSorunsuz.km || "—"})`;
    } else {
      alan.innerHTML = "Henüz bildirim yapmadın.";
    }
  }
}

// silMasraf: yerel veriyi günceller ve firebase'e yazar (firebase fonksiyonu aşağıda tanımlı)
function silMasraf(index){
  if(typeof index !== "number") return;
  // index guard
  if(index < 0 || index >= masraflar.length) return;
  masraflar.splice(index, 1);
  localStorage.setItem(key + "_masraf", JSON.stringify(masraflar));
  // firebase yaz (tanımlandıysa)
  if(typeof window.firebaseYaz === "function") window.firebaseYaz();
  render();
}

// dinamik olarak localStorage başka sekmeden güncellenirse yakala
window.addEventListener("storage", function(e){
  if(!e.key) return;
  if(e.key === key + "_masraf"){
    masraflar = JSON.parse(localStorage.getItem(key + "_masraf")) || [];
    render();
  }
  if(e.key === key + "_sorunsuz"){
    sorunsuz = JSON.parse(localStorage.getItem(key + "_sorunsuz")) || [];
    render();
  }
});

// ilk render
render();
</script>

<!-- Firestore senkronizasyonu (dokunmayın, firebase.js'de db export olmalı) -->
<script type="module">
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { db } from "./firebase.js";

const firebaseRef = doc(db, "cars", key);

// Firebase -> LocalStorage (ilk açılış)
async function firebaseOku(){
  try{
    const snap = await getDoc(firebaseRef);
    if(snap.exists()){
      const data = snap.data();
      if(data.masraflar){
        masraflar = data.masraflar;
        localStorage.setItem(key + "_masraf", JSON.stringify(masraflar));
      }
      if(data.sorunsuz){
        sorunsuz = data.sorunsuz;
        localStorage.setItem(key + "_sorunsuz", JSON.stringify(sorunsuz));
      }
      render();
    }
  }catch(err){
    console.warn("firebaseOku hata:", err);
  }
}
firebaseOku();

// LocalStorage -> Firebase (manuel çağrılacak)
export async function firebaseYaz(){
  try{
    await setDoc(firebaseRef, {
      masraflar: masraflar || [],
      sorunsuz: sorunsuz || []
    });
  }catch(err){
    console.warn("firebaseYaz hata:", err);
  }
}
// expose to window for calls from inline script
window.firebaseYaz = firebaseYaz;
</script>

</body>
</html>