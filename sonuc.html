<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Araç Masraf Analizi</title>

<style>
/* ---- Tema / Stil (kullandığın açık tema ile uyumlu) ---- */
body{
  margin:0;
  min-height:100vh;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#eaf6fb,#f7fcfe);
  padding:20px;
  color:#1f2937;
}
.container{
  max-width:900px;
  margin:auto;
  background:#ffffff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 6px 30px rgba(32,33,36,0.08);
}
h1,h3{margin-top:20px;color:#0f172a}
button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
  margin:6px 6px 6px 0;
}
.primary{background:#3498db;color:#fff}
.success{background:#10b981;color:#fff}
.danger{background:#ef4444;color:#fff}
.gray{background:#64748b;color:#fff}
/* Bars */
.bar-container{
  width:100%;
  background:#eef2f6;
  border-radius:8px;
  margin-bottom:10px;
  overflow:hidden;
}
.bar{
  height:30px;
  line-height:30px;
  padding-left:12px;
  border-radius:6px;
  font-size:14px;
  color:#fff;
  font-weight:600;
  box-sizing:border-box;
}
.low{background:linear-gradient(90deg,#10b981,#34d399)}
.mid{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.high{background:linear-gradient(90deg,#ef4444,#fb6b6b)}
.neutral{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.kmbar{background:linear-gradient(90deg,#0ea5a4,#5eead4)}
.satisbar{background:linear-gradient(90deg,#6366f1,#818cf8)}
.masrafbar{background:linear-gradient(90deg,#2563eb,#38bdf8)}
.kendi-box{
  background:#f8fafc;
  padding:12px;
  border-radius:8px;
}
.kendi-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.kendi-item button{
  padding:6px 10px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.kendi-item .danger{background:#ef4444;color:#fff}

/* Popup */
.popup-bg{
  position:fixed; inset:0; display:none;
  background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:999;
}
.popup{
  background:#fff; padding:18px; border-radius:10px; width:320px; box-shadow:0 12px 40px rgba(0,0,0,0.2);
}
.popup h3{margin:0 0 10px 0}
.popup select, .popup button{width:100%; padding:10px; margin-top:10px; font-size:14px}
.popup .row{display:flex; gap:8px;}
.popup .row select{flex:1}

/* small helpers */
.info{margin:12px 0;color:#334155}
</style>
</head>

<body>

<div class="container">

  <h1 id="baslik">Araç Masraf Analizi</h1>

  <button class="danger" id="yasadimBtn">Bu aracı kullanırken masraf yaşadım</button>
  <button class="success" id="yasamadimBtn">Bu aracı kullanırken masraf yaşamadım</button>
  <button class="gray" id="geriBtn">← Araç Seçimine Dön</button>

  <hr>

  <div id="istatistik" class="info"></div>

  <h3>Masraf Riski</h3>
  <div id="riskGrafik"></div>

  <h3>Masraf Türleri</h3>
  <div id="masrafGrafik"></div>

  <h3>Bin KM Aralıkları</h3>
  <div id="kmGrafik"></div>

  <h3>Satış Süresi</h3>
  <div id="satisGrafik"></div>

  <h3>Senin Bildirimin</h3>
  <div id="kendiBildirim" class="kendi-box"></div>

</div>

<!-- MASRAF POPUP -->
<div class="popup-bg" id="masrafPopup">
  <div class="popup" role="dialog" aria-modal="true">
    <h3>Masraf Bildir</h3>

    <select id="popupMasrafTuru">
      <option value="">Masraf Türü</option>
      <option>Motor</option>
      <option>Şanzıman</option>
      <option>Elektrik</option>
      <option>Süspansiyon</option>
      <option>Fren</option>
    </select>

    <select id="popupKm">
      <option value="">Bin KM aralığı</option>
      <option>0–50</option>
      <option>50–100</option>
      <option>100–150</option>
      <option>150–200</option>
      <option>200–250</option>
      <option>250–300</option>
      <option>300+</option>
    </select>

    <button id="popupMasrafEkle" class="primary">Ekle</button>
    <button id="popupMasrafKapat" class="gray">Kapat</button>
  </div>
</div>

<!-- SORUNSUZ POPUP -->
<div class="popup-bg" id="sorunsuzPopup">
  <div class="popup" role="dialog" aria-modal="true">
    <h3>Masraf Yaşamadım</h3>

    <select id="popupSorunsuzKm">
      <option value="">Bu aracı kaç km kullandın?</option>
      <option>0–10</option>
      <option>10–50</option>
      <option>50–100</option>
      <option>100–150</option>
      <option>150–200</option>
      <option>200–250</option>
      <option>250–300</option>
      <option>300+</option>
    </select>

    <button id="popupSorunsuzKaydet" class="primary">Kaydet</button>
    <button id="popupSorunsuzKapat" class="gray">Kapat</button>
  </div>
</div>

<script>
// === GİRİŞ KONTROLÜ ===
if(!localStorage.getItem("userEmail")){
  location.href="index.html";
}

// USER ID
let userId = localStorage.getItem("userId");
if(!userId){
  userId = "u_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId", userId);
}

// AKTİF ARAÇ
const arac = JSON.parse(localStorage.getItem("aktifArac"));
if(!arac){
  location.href = "arac-sec.html";
}
const key = `${arac.marka}-${arac.model}-${arac.yil}-${arac.motor}`;
document.getElementById("baslik").innerText =
  `${arac.marka} ${arac.model} (${arac.yil}) - ${arac.motor}`;

// VERİLER
let masraflar = JSON.parse(localStorage.getItem(key + "_masraf")) || [];
let sorunsuz = JSON.parse(localStorage.getItem(key + "_sorunsuz")) || [];

/* =========================
   RENDER / GÖSTERİM
   ========================= */
function render(){

  // geçerli sorunsuzlar (gecerli olmazsa sayma)
  const gecerliSorunsuz = sorunsuz.filter(s => s.gecerli !== false);

  // toplam kullanıcı
  const toplamKullanici = new Set([
    ...masraflar.map(m => m.userId),
    ...gecerliSorunsuz.map(s => s.userId)
  ]).size;

  const masrafci = new Set(masraflar.map(m => m.userId)).size;
  const riskOran = toplamKullanici ? Math.round((masrafci / toplamKullanici) * 100) : 0;

  document.getElementById("istatistik").innerHTML =
    `<strong>${toplamKullanici} kullanıcıdan ${masrafci} kullanıcı masraf bildirdi</strong>`;

  // risk
  let riskClass = "low";
  if(riskOran > 60) riskClass = "high";
  else if(riskOran > 25) riskClass = "mid";
  document.getElementById("riskGrafik").innerHTML =
    `<div class="bar-container"><div class="bar ${riskClass}" style="width:${riskOran}%">Masraf Riski %${riskOran}</div></div>`;

  // masraf türleri
  const turSayac = {};
  masraflar.forEach(m => turSayac[m.tur || "Bilinmiyor"] = (turSayac[m.tur]||0) + 1);

  document.getElementById("masrafGrafik").innerHTML =
    Object.keys(turSayac).length
      ? Object.keys(turSayac).map(t=>{
          const denom = masraflar.length || 1;
          const y = Math.round((turSayac[t] / denom) * 100);
          return `<div class="bar-container"><div class="bar masrafbar" style="width:${y}%">${t} %${y}</div></div>`;
        }).join("")
      : "<em>Masraf verisi yok</em>";

  // KM aralığı
  const kmSayac = {};
  masraflar.forEach(m => kmSayac[m.km || "Bilinmiyor"] = (kmSayac[m.km]||0) + 1);

  document.getElementById("kmGrafik").innerHTML =
    Object.keys(kmSayac).length
      ? Object.keys(kmSayac).map(k=>{
          const denom = masraflar.length || 1;
          const y = Math.round((kmSayac[k] / denom) * 100);
          return `<div class="bar-container"><div class="bar kmbar" style="width:${y}%">${k} %${y}</div></div>`;
        }).join("")
      : "<em>KM verisi yok</em>";

  // satış süresi: masraflar.satis veya masraflar.satisGun; sorunsuz kayıtlar da katkı sağlar
  const satisSayac = {"0-15":0,"15-30":0,"30+":0};
  function extractSatis(o){
    return o.satis || o.satisGun || "";
  }
  masraflar.forEach(m => { const s = extractSatis(m); if(s && satisSayac.hasOwnProperty(s)) satisSayac[s]++; });
  gecerliSorunsuz.forEach(s => { const v = extractSatis(s); if(v && satisSayac.hasOwnProperty(v)) satisSayac[v]++; });

  const toplamSatis = Object.values(satisSayac).reduce((a,b)=>a+b,0);
  document.getElementById("satisGrafik").innerHTML =
    toplamSatis
      ? Object.keys(satisSayac).map(k=>{
          const y = Math.round((satisSayac[k] / (toplamSatis || 1)) * 100);
          return `<div class="bar-container"><div class="bar satisbar" style="width:${y}%">${k} gün %${y}</div></div>`;
        }).join("")
      : "<em>Satış süresi verisi yok</em>";

  // kendi bildirimler + sil butonu
  const alan = document.getElementById("kendiBildirim");
  const benim = masraflar.map((m,i)=>({...m,_i:i})).filter(m => m.userId === userId);

  if(benim.length){
    alan.innerHTML = benim.map(m => `
      <div class="kendi-item">
        <div>${m.tur || "—"} <small>(${m.km || "—"})</small></div>
        <div><button class="danger" onclick="silMasraf(${m._i})">Sil</button></div>
      </div>
    `).join("");
  } else {
    const benimSorunsuz = sorunsuz.find(s => s.userId === userId);
    if(benimSorunsuz){
      alan.innerHTML = `Bu araçta masraf yaşamadığını bildirdin. (KM: ${benimSorunsuz.km || "—"})`;
    } else {
      alan.innerHTML = "Henüz bildirim yapmadın.";
    }
  }
}

/* silMasraf: localStorage güncelle ve firebase'e yaz (varsa) */
function silMasraf(index){
  if(typeof index !== "number") return;
  if(index < 0 || index >= masraflar.length) return;
  masraflar.splice(index,1);
  localStorage.setItem(key + "_masraf", JSON.stringify(masraflar));
  if(typeof window.firebaseYaz === "function") window.firebaseYaz();
  render();
}

/* storage event ile diğer sekmelerden gelen değişiklikleri yakala */
window.addEventListener("storage", function(e){
  if(!e.key) return;
  if(e.key === key + "_masraf"){
    masraflar = JSON.parse(localStorage.getItem(key + "_masraf")) || [];
    render();
  }
  if(e.key === key + "_sorunsuz"){
    sorunsuz = JSON.parse(localStorage.getItem(key + "_sorunsuz")) || [];
    render();
  }
});

/* ilk render */
render();

/* =========================
   POPUP VE BUTONLAR (DOM hazırlığı garantisi)
   ========================= */
document.addEventListener("DOMContentLoaded", function(){

  // buton referansları
  const yasadimBtn = document.getElementById("yasadimBtn");
  const yasamadimBtn = document.getElementById("yasamadimBtn");
  const geriBtn = document.getElementById("geriBtn");

  const masrafPopup = document.getElementById("masrafPopup");
  const sorunsuzPopup = document.getElementById("sorunsuzPopup");

  const popupMasrafTuru = document.getElementById("popupMasrafTuru");
  const popupKm = document.getElementById("popupKm");
  
  const popupMasrafEkle = document.getElementById("popupMasrafEkle");
  const popupMasrafKapat = document.getElementById("popupMasrafKapat");

  const popupSorunsuzKm = document.getElementById("popupSorunsuzKm");
  
 const popupSorunsuzKaydet = document.getElementById("popupSorunsuzKaydet");
  const popupSorunsuzKapat = document.getElementById("popupSorunsuzKapat");

  // aç / kapat fonksiyonları
  function openPopup(p){ p.style.display = "flex"; }
  function closePopup(p){ p.style.display = "none"; }

  // ESC ile kapat
  window.addEventListener("keydown", function(e){
    if(e.key === "Escape"){ closePopup(masrafPopup); closePopup(sorunsuzPopup); }
  });

  // butonlara tıklama
  yasadimBtn.onclick = function(){
    // masraf popup aç
    openPopup(masrafPopup);
  };

  yasamadimBtn.onclick = function(){
    // sorunsuz popup aç
    openPopup(sorunsuzPopup);
  };

  geriBtn.onclick = function(){ location.href = "arac-sec.html"; };

  // masraf ekle
  popupMasrafEkle.onclick = function(){
    const tur = popupMasrafTuru.value;
    const km  = popupKm.value;
   

    if(!tur || !km){
      alert("Lütfen masraf türü ve KM aralığını seçin.");
      return;
    }

    masraflar.push({ userId, tur, km, });
    localStorage.setItem(key + "_masraf", JSON.stringify(masraflar));
    if(typeof window.firebaseYaz === "function") window.firebaseYaz();
    closePopup(masrafPopup);
    // temizle
    popupMasrafTuru.value = "";
    popupKm.value = "";
  
    render();
  };

  popupMasrafKapat.onclick = function(){ closePopup(masrafPopup); };

  // sorunsuz kaydet
  popupSorunsuzKaydet.onclick = function(){
    const km = popupSorunsuzKm.value;
    

    if(!km){
      alert("Lütfen KM aralığını seçin.");
      return;
    }

    const gecerli = !(km === "0–10" || km === "10–50");
    sorunsuz.push({ userId, km, gecerli });
    localStorage.setItem(key + "_sorunsuz", JSON.stringify(sorunsuz));
    if(typeof window.firebaseYaz === "function") window.firebaseYaz();
    closePopup(sorunsuzPopup);
    popupSorunsuzKm.value = "";
    
    render();
  };

  popupSorunsuzKapat.onclick = function(){ closePopup(sorunsuzPopup); };

  // kapatma için popup arka planına tıklama
  masrafPopup.addEventListener("click", function(e){
    if(e.target === masrafPopup) closePopup(masrafPopup);
  });
  sorunsuzPopup.addEventListener("click", function(e){
    if(e.target === sorunsuzPopup) closePopup(sorunsuzPopup);
  });

}); // DOMContentLoaded
</script>

<!-- Firestore entegrasyonu: (varsa firebase.js ile çalışır) -->
<script type="module">
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { db } from "./firebase.js"; // senin firebase.js'inde `export const db = ...` olmalı

const firebaseRef = doc(db, "cars", /* key */ (function(){ 
  try{ return key; }catch(e){ return ""; }
})());

// İlk açılışta Firebase'den oku (varsa)
async function firebaseOku(){
  try{
    if(!firebaseRef) return;
    const snap = await getDoc(firebaseRef);
    if(snap.exists()){
      const data = snap.data();
      if(data.masraflar){ masraflar = data.masraflar; localStorage.setItem(key + "_masraf", JSON.stringify(masraflar)); }
      if(data.sorunsuz){ sorunsuz = data.sorunsuz; localStorage.setItem(key + "_sorunsuz", JSON.stringify(sorunsuz)); }
      render();
    }
  }catch(e){
    console.warn("firebaseOku hata:", e);
  }
}
firebaseOku();

// Firebase'e yaz (diğer fonksiyonlar window.firebaseYaz() ile çağırır)
export async function firebaseYaz(){
  try{
    if(!firebaseRef) return;
    await setDoc(firebaseRef,{
      masraflar: masraflar || [],
      sorunsuz: sorunsuz || []
    });
  }catch(e){
    console.warn("firebaseYaz hata:", e);
  }
}
// expose
window.firebaseYaz = firebaseYaz;
</script>

</body>
</html>