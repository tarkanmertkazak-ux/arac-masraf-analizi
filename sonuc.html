<<<<<<< HEAD
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>AraÃ§ Masraf Analizi</title>

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e2a38,#2f6f85,#4fb0c6);
  padding:20px;
}

.container{
  max-width:900px;
  margin:auto;
  background:#ffffff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 0 20px rgba(0,0,0,.1);
}

h1,h3{margin-top:20px}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
  margin:6px 4px;
}

.primary{background:#3498db;color:#fff}
.success{background:#2ecc71;color:#fff}
.danger{background:#e74c3c;color:#fff}
.gray{background:#7f8c8d;color:#fff}

.bar-container{
  width:100%;
  background:#ecf0f1;
  border-radius:8px;
  margin-bottom:10px;
}
.bar{
  height:24px;
  line-height:24px;
  padding-left:10px;
  border-radius:8px;
  font-size:14px;
  color:#fff;
}

/* .low{background:#2ecc71}
.mid{background:#f1c40f}
.high{background:#e74c3c}
.neutral{background:#95a5a6} */

.kendi-box{
  background:#f9f9f9;
  padding:12px;
  border-radius:8px;
}
.kendi-item{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.gray{
  background:linear-gradient(90deg,#2f6f85,#4fb0c6);
}
/* OKUNAKLI GRAFÄ°K BARLARI */
.bar{
  background:linear-gradient(90deg,#2f6f85,#4fb0c6);
  color:#ffffff;
  font-weight:600;
  text-shadow:0 1px 2px rgba(0,0,0,.35);
}

/* SatÄ±ÅŸ sÃ¼resi barlarÄ± */
.bar.satis{
  background:linear-gradient(90deg,#3b82f6,#60a5fa);
}

/* Masraf tÃ¼rleri */
.bar.masraf{
  background:linear-gradient(90deg,#2563eb,#38bdf8);
}

/* KM aralÄ±klarÄ± */
.bar.km{
  background:linear-gradient(90deg,#0ea5a4,#5eead4);
}
.low{background:#2ecc71}
.mid{background:#f1c40f}
.high{background:#e74c3c}
.neutral{background:#2f6f85,#5eead4}

</style>
</head>

<body>

<div class="container">

<h1 id="baslik"></h1>

<button class="danger" id="yasadimBtn">Bu aracÄ± kullanÄ±rken masraf yaÅŸadÄ±m</button>
<button class="success" id="yasamadimBtn">Bu aracÄ± kullanÄ±rken masraf yaÅŸamadÄ±m</button>
<button class="gray" onclick="location.href='arac-sec.html'">â† AraÃ§ SeÃ§imine DÃ¶n</button>

<hr>

<div id="istatistik"></div>

<h3>Masraf Riski</h3>
<div id="riskGrafik"></div>

<h3>Masraf TÃ¼rleri</h3>
<div id="masrafGrafik"></div>

<h3>Bin KM AralÄ±klarÄ±</h3>
<div id="kmGrafik"></div>

<h3>SatÄ±ÅŸ SÃ¼resi</h3>
<div id="satisGrafik"></div>

<h3>Senin Bildirimin</h3>
<div id="kendiBildirim" class="kendi-box"></div>

</div>

<script>
// GÄ°RÄ°Å
if(!localStorage.getItem("userEmail")){
  location.href="index.html";
}

// USER
let userId = localStorage.getItem("userId");
if(!userId){
  userId="u_"+Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId",userId);
}

// ARAÃ‡
const arac = JSON.parse(localStorage.getItem("aktifArac"));
if(!arac) location.href="arac-sec.html";

const key = `${arac.marka}-${arac.model}-${arac.yil}-${arac.motor}`;
document.getElementById("baslik").innerText =
`${arac.marka} ${arac.model} (${arac.yil}) - ${arac.motor}`;

// VERÄ°LER
let masraflar = JSON.parse(localStorage.getItem(key+"_masraf")) || [];
let sorunsuz = JSON.parse(localStorage.getItem(key+"_sorunsuz")) || [];

// RENDER
function render(){

  // ğŸ”¹ GEÃ‡ERLÄ° SORUNSUZLAR
  const gecerliSorunsuz = sorunsuz.filter(s=>s.gecerli && s.satis);

  // ğŸ”¹ KULLANICI SAYISI
  const toplamKullanici = new Set([
    ...masraflar.map(m=>m.userId),
    ...gecerliSorunsuz.map(s=>s.userId)
  ]).size;

  const masrafci = new Set(masraflar.map(m=>m.userId)).size;
  const riskOran = toplamKullanici
    ? Math.round((masrafci / toplamKullanici) * 100)
    : 0;

  document.getElementById("istatistik").innerHTML =
    `<strong>${toplamKullanici} kullanÄ±cÄ±dan ${masrafci} kullanÄ±cÄ± masraf bildirdi</strong>`;

  let riskClass="low";
  if(riskOran>60) riskClass="high";
  else if(riskOran>25) riskClass="mid";

  document.getElementById("riskGrafik").innerHTML =
    `<div class="bar-container">
      <div class="bar ${riskClass}" style="width:${riskOran}%">
        Masraf Riski %${riskOran}
      </div>
    </div>`;

  // ğŸ”¹ MASRAF TÃœRLERÄ°
  const turSayac={};
  masraflar.forEach(m=>turSayac[m.tur]=(turSayac[m.tur]||0)+1);

  document.getElementById("masrafGrafik").innerHTML =
    Object.keys(turSayac).length
    ? Object.keys(turSayac).map(t=>{
        const y=Math.round(turSayac[t]/masraflar.length*100);
        return `<div class="bar-container">
          <div class="bar neutral" style="width:${y}%">${t} %${y}</div>
        </div>`;
      }).join("")
    : "<em>Masraf verisi yok</em>";

  // ğŸ”¹ KM
  const kmSayac={};
  masraflar.forEach(m=>kmSayac[m.km]=(kmSayac[m.km]||0)+1);

  document.getElementById("kmGrafik").innerHTML =
    Object.keys(kmSayac).length
    ? Object.keys(kmSayac).map(k=>{
        const y=Math.round(kmSayac[k]/masraflar.length*100);
        return `<div class="bar-container">
          <div class="bar neutral" style="width:${y}%">${k} %${y}</div>
        </div>`;
      }).join("")
    : "<em>KM verisi yok</em>";

  // ğŸ”¹ SATIÅ SÃœRESÄ° (ğŸ’¥ ARTIK Ã‡ALIÅIYOR)
  const satisSayac={"0-15":0,"15-30":0,"30+":0};

  masraflar.forEach(m=>{
    if(m.satis) satisSayac[m.satis]++;
  });
  gecerliSorunsuz.forEach(s=>{
    if(s.satis) satisSayac[s.satis]++;
  });

  const toplamSatis = Object.values(satisSayac).reduce((a,b)=>a+b,0);

  document.getElementById("satisGrafik").innerHTML =
    toplamSatis
    ? Object.keys(satisSayac).map(k=>{
        const y=Math.round(satisSayac[k]/toplamSatis*100);
        return `<div class="bar-container">
          <div class="bar neutral" style="width:${y}%">${k} gÃ¼n %${y}</div>
        </div>`;
      }).join("")
    : "<em>SatÄ±ÅŸ sÃ¼resi verisi yok</em>";

  // ğŸ”¹ KENDÄ° BÄ°LDÄ°RÄ°M
  const alan=document.getElementById("kendiBildirim");
  const benim=masraflar.map((m,i)=>({...m,i})).filter(m=>m.userId===userId);

  if(benim.length){
    
    alan.innerHTML=benim.map(m=>
      `<div class="kendi-item">
        ${m.tur} (${m.km})
        <button class="danger" onclick="silMasraf(${m.i})">Sil</button>
      </div>`
    ).join("");
  }else{
    alan.innerHTML="HenÃ¼z bildirim yapmadÄ±n.";
  }
}

function silMasraf(i){
  masraflar.splice(i,1);
  localStorage.setItem(key+"_masraf",JSON.stringify(masraflar));
  render();
}

render();
</script>
<script type="module">
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { db } from "./firebase.js";

/*
  âš ï¸ DOKUNMA
  Bu kod, mevcut localStorage yapÄ±nÄ± BOZMADAN
  Firebase ile senkronizasyon yapar
*/

// ARAÃ‡ ANAHTARI (ZATEN VAR OLAN KEY KULLANILIYOR)
const firebaseRef = doc(db, "cars", key);

// ğŸ”¹ Firebase â†’ LocalStorage (sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda)
async function firebaseOku(){
  try{
    const snap = await getDoc(firebaseRef);
    if(snap.exists()){
      const data = snap.data();

      if(data.masraflar){
        masraflar = data.masraflar;
        localStorage.setItem(key+"_masraf", JSON.stringify(masraflar));
      }

      if(data.sorunsuz){
        sorunsuz = data.sorunsuz;
        localStorage.setItem(key+"_sorunsuz", JSON.stringify(sorunsuz));
      }

      render();
    }
  }catch(e){
    console.error("Firebase okuma hatasÄ±:", e);
  }
}
firebaseOku();

// ğŸ”¹ LocalStorage â†’ Firebase (manuel Ã§aÄŸrÄ±lÄ±r)
async function firebaseYaz(){
  try{
    await setDoc(firebaseRef,{
      masraflar: masraflar || [],
      sorunsuz: sorunsuz || []
    });
  }catch(e){
    console.error("Firebase yazma hatasÄ±:", e);
  }
}

// ğŸ”¹ MEVCUT FONKSÄ°YONLARA DOKUNMADAN YAKALAMA
// Masraf silinince Firebase'e de yaz
const _silMasraf = window.silMasraf;
window.silMasraf = function(i){
  _silMasraf(i);
  firebaseYaz();
};

// Ä°lk render sonrasÄ± Firebaseâ€™e ilk kayÄ±t (boÅŸsa)
firebaseYaz();
</script>
</body>
=======
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>AraÃ§ Masraf Analizi</title>

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e2a38,#2f3e52);
  padding:20px;
}

.container{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:25px;
  border-radius:20px;
  box-shadow:0 30px 60px rgba(0,0,0,.35);
}

h1{margin-top:0}

.bar-container{
  width:100%;
  background:#e0e0e0;
  margin-bottom:8px;
  border-radius:6px;
}
.bar{
  height:24px;
  line-height:24px;
  color:#fff;
  padding-left:8px;
  font-size:14px;
  border-radius:6px;
}

.low{background:#2ecc71}
.mid{background:#f1c40f}
.high{background:#e74c3c}
.gray{background:#34495e}

button{
  padding:12px 16px;
  margin:6px 0;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:15px;
}

#yasadimBtn{background:#e74c3c;color:#fff}
#yasamadimBtn{background:#2ecc71;color:#fff}

.popup-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.popup{
  background:#fff;
  padding:20px;
  width:340px;
  border-radius:16px;
}

.kendi-box{
  background:#f4f6f8;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
}
.kendi-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.kendi-item button{
  background:#c0392b;
  color:#fff;
  padding:6px 10px;
  font-size:13px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="container">

<h1 id="baslik"></h1>

<button id="yasadimBtn">Bu aracÄ± kullanÄ±rken masraf yaÅŸadÄ±m</button>
<button id="yasamadimBtn">Bu aracÄ± kullanÄ±rken masraf yaÅŸamadÄ±m</button>

<hr>

<div id="istatistik"></div>

<h3>Masraf Riski</h3>
<div id="riskGrafik"></div>

<h3>Masraf TÃ¼rleri</h3>
<div id="masrafGrafik"></div>

<h3>Bin KM AralÄ±klarÄ±</h3>
<div id="kmGrafik"></div>

<h3>Senin Bildirimin</h3>
<div id="kendiBildirim" class="kendi-box"></div>

</div>

<!-- MASRAF POPUP -->
<div class="popup-bg" id="masrafPopup">
<div class="popup">
<h3>Masraf Bildir</h3>

<select id="masrafTuru">
  <option value="">Masraf TÃ¼rÃ¼</option>
  <option>Motor</option>
  <option>ÅanzÄ±man</option>
  <option>Elektrik</option>
  <option>SÃ¼spansiyon</option>
  <option>Fren</option>
</select><br><br>

<select id="km">
  <option value="">Bin KM AralÄ±ÄŸÄ±</option>
  <option>0â€“50</option>
  <option>50â€“100</option>
  <option>100â€“150</option>
  <option>150â€“200</option>
  <option>200â€“250</option>
  <option>250â€“300</option>
  <option>300+</option>
</select><br><br>

<button onclick="masrafEkle()">Ekle</button>
<button onclick="kapat()">VazgeÃ§</button>
</div>
</div>

<!-- SORUNSUZ POPUP -->
<div class="popup-bg" id="sorunsuzPopup">
<div class="popup">
<h3>Masraf YaÅŸamadÄ±m</h3>

<select id="sorunsuzKm">
  <option value="">Bu aracÄ± kaÃ§ km kullandÄ±n?</option>
  <option>0â€“10</option>
  <option>10â€“50</option>
  <option>50â€“100</option>
  <option>100â€“150</option>
  <option>150â€“200</option>
  <option>200â€“250</option>
  <option>250â€“300</option>
  <option>300+</option>
</select><br><br>

<button onclick="sorunsuzKaydet()">Kaydet</button>
<button onclick="kapat()">VazgeÃ§</button>
</div>
</div>

<script>
// === GÄ°RÄ°Å ===
if(!localStorage.getItem("userEmail")){
  location.href="index.html";
}

// === USER ===
let userId = localStorage.getItem("userId");
if(!userId){
  userId="u_"+Math.random().toString(36).substr(2,9);
  localStorage.setItem("userId",userId);
}

// === ARAÃ‡ ===
const arac = JSON.parse(localStorage.getItem("aktifArac"));
if(!arac){ location.href="arac-sec.html"; }

const key = `${arac.marka}-${arac.model}-${arac.yil}-${arac.motor}`;
baslik.innerText = `${arac.marka} ${arac.model} (${arac.yil}) - ${arac.motor}`;

// === VERÄ° ===
let masraflar = JSON.parse(localStorage.getItem(key+"_masraf")) || [];
let sorunsuzlar = JSON.parse(localStorage.getItem(key+"_sorunsuz")) || [];

// === POPUP ===
yasadimBtn.onclick=()=>{
  sorunsuzlar = sorunsuzlar.filter(u=>u.userId!==userId);
  localStorage.setItem(key+"_sorunsuz",JSON.stringify(sorunsuzlar));
  masrafPopup.style.display="flex";
};
yasamadimBtn.onclick=()=>{
  masraflar = masraflar.filter(m=>m.userId!==userId);
  localStorage.setItem(key+"_masraf",JSON.stringify(masraflar));
  sorunsuzPopup.style.display="flex";
};
function kapat(){
  masrafPopup.style.display="none";
  sorunsuzPopup.style.display="none";
}

// === MASRAF EKLE ===
function masrafEkle(){
  const tur = masrafTuru.value;
  const km  = document.getElementById("km").value;
  if(!tur || !km) return;

  masraflar.push({userId,tur,km});
  localStorage.setItem(key+"_masraf",JSON.stringify(masraflar));
  kapat();
  render();
}

// === MASRAF SÄ°L ===
function masrafSil(index){
  masraflar.splice(index,1);
  localStorage.setItem(key+"_masraf",JSON.stringify(masraflar));
  render();
}

// === SORUNSUZ ===
function sorunsuzKaydet(){
  const km = sorunsuzKm.value;
  if(!km) return;
  const gecerli = !(km==="0â€“10" || km==="10â€“50");
  sorunsuzlar.push({userId,km,gecerli});
  localStorage.setItem(key+"_sorunsuz",JSON.stringify(sorunsuzlar));
  kapat();
  render();
}

// === RENDER ===
function render(){
  const gecerliSorunsuz = sorunsuzlar.filter(s=>s.gecerli);

  const toplam = new Set([
    ...masraflar.map(m=>m.userId),
    ...gecerliSorunsuz.map(s=>s.userId)
  ]).size;

  const masrafci = new Set(masraflar.map(m=>m.userId)).size;
  const oran = toplam ? Math.round((masrafci/toplam)*100) : 0;

  istatistik.innerHTML =
    `<strong>${toplam} kullanÄ±cÄ±dan ${masrafci} kullanÄ±cÄ± masraf bildirdi</strong>`;

  let risk="low";
  if(oran>60) risk="high";
  else if(oran>25) risk="mid";

  riskGrafik.innerHTML =
    `<div class="bar-container">
      <div class="bar ${risk}" style="width:${oran}%">
        Masraf Riski %${oran}
      </div>
    </div>`;

  // === MASRAF TÃœRÃœ GRAFÄ°ÄÄ° (YÃœZDELER GERÄ° GELDÄ°) ===
  const turSay={};
  masraflar.forEach(m=>turSay[m.tur]=(turSay[m.tur]||0)+1);
  let turHtml="";
  for(let t in turSay){
    const y=Math.round((turSay[t]/masraflar.length)*100);
    turHtml+=`<div class="bar-container">
      <div class="bar gray" style="width:${y}%">${t} %${y}</div>
    </div>`;
  }
  masrafGrafik.innerHTML = turHtml || "<em>Veri yok</em>";

  // === KM GRAFÄ°ÄÄ° ===
  const kmSay={};
  masraflar.forEach(m=>kmSay[m.km]=(kmSay[m.km]||0)+1);
  let kmHtml="";
  for(let k in kmSay){
    const y=Math.round((kmSay[k]/masraflar.length)*100);
    kmHtml+=`<div class="bar-container">
      <div class="bar gray" style="width:${y}%">${k} %${y}</div>
    </div>`;
  }
  kmGrafik.innerHTML = kmHtml || "<em>Veri yok</em>";

  // === KENDÄ° BÄ°LDÄ°RÄ°M + SÄ°L BUTONU ===
  const benim = masraflar
    .map((m,i)=>({...m,index:i}))
    .filter(m=>m.userId===userId);

  if(benim.length){
    kendiBildirim.innerHTML = benim.map(m=>`
      <div class="kendi-item">
        <span>${m.tur} (${m.km})</span>
        <button onclick="masrafSil(${m.index})">Sil</button>
      </div>
    `).join("");
  }else{
    kendiBildirim.innerHTML="HenÃ¼z bildirim yapmadÄ±n.";
  }
}

render();
</script>

</body>
>>>>>>> ee881aeade7eb990bf59063740a1cb5bc749c11e
</html>